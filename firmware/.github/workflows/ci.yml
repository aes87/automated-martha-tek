name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: [main]

jobs:
  # ── Job 1: ESP32 compile check ─────────────────────────────────────────────
  build-esp32:
    name: Build (ESP32)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            ~/.cache/pip
          key: ${{ runner.os }}-pio-${{ hashFiles('platformio.ini') }}

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Compile ESP32 firmware
        run: pio run -e esp32dev
        working-directory: firmware

  # ── Job 2: Native unit tests ───────────────────────────────────────────────
  test-native:
    name: Unit Tests (native)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            ~/.cache/pip
          key: ${{ runner.os }}-pio-native-${{ hashFiles('platformio.ini') }}

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Run native unit tests
        run: pio test -e native -v
        working-directory: firmware

  # ── Job 3: Release build (on tag push) ────────────────────────────────────
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [build-esp32, test-native]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: ~/.platformio
          key: ${{ runner.os }}-pio-release-${{ hashFiles('platformio.ini') }}

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Build firmware binary
        run: pio run -e esp32dev
        working-directory: firmware

      - name: Build LittleFS image
        run: pio run --target buildfs -e esp32dev
        working-directory: firmware

      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Rename artifacts
        run: |
          mv firmware/.pio/build/esp32dev/firmware.bin \
             martha-controller-${{ steps.get_version.outputs.version }}.bin
          mv firmware/.pio/build/esp32dev/littlefs.bin \
             martha-littlefs-${{ steps.get_version.outputs.version }}.bin

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Martha Controller ${{ steps.get_version.outputs.version }}
          body: |
            ## Martha Tent Controller ${{ steps.get_version.outputs.version }}

            ### Flashing
            ```bash
            esptool.py --chip esp32 --port /dev/ttyUSB0 --baud 921600 write_flash \
              0x1000  bootloader.bin \
              0x8000  partitions.bin \
              0xe000  boot_app0.bin \
              0x10000 martha-controller-${{ steps.get_version.outputs.version }}.bin

            # Flash LittleFS web UI
            esptool.py --chip esp32 --port /dev/ttyUSB0 --baud 921600 write_flash \
              0x290000 martha-littlefs-${{ steps.get_version.outputs.version }}.bin
            ```

            ### OTA Update
            Navigate to `http://martha.local/update` and upload the `.bin` file.
          files: |
            martha-controller-${{ steps.get_version.outputs.version }}.bin
            martha-littlefs-${{ steps.get_version.outputs.version }}.bin
