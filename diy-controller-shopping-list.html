<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DIY ESP32-S3 Controller — Shopping List</title>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --border: #30363d;
    --text: #e6edf3;
    --muted: #8b949e;
    --accent: #58a6ff;
    --green: #3fb950;
    --orange: #d29922;
    --red: #f85149;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    font-size: 14px;
    line-height: 1.5;
    min-height: 100vh;
  }

  /* Sticky header */
  #site-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 16px;
  }

  #site-header .header-inner {
    max-width: 800px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 12px;
    height: 52px;
  }

  #site-header h1 {
    font-size: 15px;
    font-weight: 600;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .back-link {
    color: var(--accent);
    text-decoration: none;
    font-size: 13px;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .back-link:hover { text-decoration: underline; }

  #settings-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 6px;
    padding: 4px 10px;
    cursor: pointer;
    font-size: 14px;
    flex-shrink: 0;
    transition: background 0.15s;
  }
  #settings-btn:hover { background: var(--border); }

  /* Settings panel */
  #settings-panel {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    overflow: hidden;
    max-height: 0;
    transition: max-height 0.25s ease, padding 0.25s ease;
    padding: 0 16px;
  }
  #settings-panel.open {
    max-height: 360px;
    padding: 16px;
  }

  #settings-panel .panel-inner {
    max-width: 800px;
    margin: 0 auto;
  }

  #settings-panel p {
    color: var(--muted);
    font-size: 13px;
    line-height: 1.6;
    margin-bottom: 12px;
  }

  .pat-row {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 10px;
    flex-wrap: wrap;
  }

  .pat-row input[type="password"] {
    flex: 1;
    min-width: 180px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    padding: 6px 10px;
    font-size: 13px;
    font-family: 'SFMono-Regular', Consolas, monospace;
  }
  .pat-row input[type="password"]:focus {
    outline: none;
    border-color: var(--accent);
  }

  .btn-sm {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 6px;
    padding: 5px 12px;
    cursor: pointer;
    font-size: 13px;
    white-space: nowrap;
    transition: background 0.15s;
  }
  .btn-sm:hover { background: var(--border); }

  #sync-status {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
    min-height: 18px;
  }
  #sync-status.syncing { color: var(--accent); }
  #sync-status.synced  { color: var(--green); }
  #sync-status.error   { color: var(--red); }
  #sync-status.local   { color: var(--muted); }

  /* Main content */
  #main {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px 16px 60px;
  }

  /* Progress bar */
  #progress-wrap {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
  }

  #progress-bar-bg {
    flex: 1;
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
  }

  #progress-bar-fill {
    height: 100%;
    background: var(--green);
    border-radius: 3px;
    width: 0%;
    transition: width 0.3s ease;
  }

  #progress-label {
    font-size: 12px;
    color: var(--muted);
    white-space: nowrap;
  }

  /* Section cards */
  .section-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 12px;
    overflow: hidden;
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    cursor: pointer;
    user-select: none;
    transition: background 0.15s;
  }
  .section-header:hover { background: rgba(255,255,255,0.03); }

  .section-title {
    flex: 1;
    font-size: 14px;
    font-weight: 600;
  }

  .section-badge {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 11px;
    color: var(--muted);
    padding: 1px 8px;
    white-space: nowrap;
  }

  .section-chevron {
    color: var(--muted);
    font-size: 12px;
    transition: transform 0.2s;
  }
  .section-card.collapsed .section-chevron {
    transform: rotate(-90deg);
  }

  .section-body {
    border-top: 1px solid var(--border);
    overflow: hidden;
  }
  .section-card.collapsed .section-body {
    display: none;
  }

  /* Item rows */
  .item-row {
    padding: 10px 16px 8px;
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
  }
  .item-row:last-child { border-bottom: none; }
  .item-row:hover { background: rgba(255,255,255,0.02); }

  .item-main {
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 0;
  }

  /* Custom checkbox */
  .item-main input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    border: 2px solid var(--border);
    border-radius: 4px;
    background: var(--bg);
    cursor: pointer;
    flex-shrink: 0;
    position: relative;
    transition: border-color 0.15s, background 0.15s;
    accent-color: var(--green);
  }
  .item-main input[type="checkbox"]:checked {
    background: var(--green);
    border-color: var(--green);
  }
  .item-main input[type="checkbox"]:checked::after {
    content: '';
    position: absolute;
    left: 3px;
    top: 0px;
    width: 5px;
    height: 9px;
    border: 2px solid #0d1117;
    border-top: none;
    border-left: none;
    transform: rotate(45deg);
  }
  .item-main input[type="checkbox"]:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  .item-label {
    flex: 1;
    cursor: pointer;
    min-width: 0;
    font-size: 14px;
  }

  .item-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }

  .badge-optional {
    color: var(--orange);
    font-size: 11px;
    border: 1px solid var(--orange);
    border-radius: 4px;
    padding: 0 5px;
    white-space: nowrap;
  }

  .item-price {
    color: var(--muted);
    font-family: 'SFMono-Regular', Consolas, monospace;
    font-size: 12px;
    white-space: nowrap;
  }

  .item-link {
    color: var(--accent);
    text-decoration: none;
    font-size: 13px;
    line-height: 1;
  }
  .item-link:hover { color: var(--text); }

  /* Checked state */
  .item-row.is-checked .item-label {
    text-decoration: line-through;
    opacity: 0.35;
  }
  .item-row.is-checked .item-meta {
    opacity: 0.35;
  }

  /* Note input */
  .item-note-wrap {
    margin-top: 5px;
    padding-left: 26px;
  }

  .item-note {
    width: 100%;
    background: transparent;
    border: none;
    border-bottom: 1px solid transparent;
    color: var(--muted);
    font-family: 'SFMono-Regular', Consolas, monospace;
    font-size: 12px;
    padding: 2px 4px;
    outline: none;
    transition: border-color 0.15s, color 0.15s;
    resize: none;
  }
  .item-note::placeholder { color: var(--border); }
  .item-note:focus {
    border-bottom-color: var(--accent);
    color: var(--text);
  }
  .item-note.has-value {
    border-bottom-color: var(--border);
    color: var(--muted);
  }

  /* Footer */
  #footer {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 16px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  #footer-note {
    color: var(--muted);
    font-size: 12px;
  }

  #reset-btn {
    background: none;
    border: 1px solid var(--red);
    color: var(--red);
    border-radius: 6px;
    padding: 5px 12px;
    cursor: pointer;
    font-size: 13px;
    transition: background 0.15s;
  }
  #reset-btn:hover { background: rgba(248, 81, 73, 0.1); }

  @media (max-width: 540px) {
    #site-header h1 { font-size: 13px; }
    .item-price { display: none; }
    #footer { flex-direction: column; gap: 10px; align-items: flex-start; }
  }
</style>
</head>
<body>

<header id="site-header">
  <div class="header-inner">
    <h1>DIY ESP32-S3 Controller — Shopping List</h1>
    <a class="back-link" href="diy-controller-build-guide.md">← DIY Controller Build Guide</a>
    <button id="settings-btn">⚙ Settings</button>
  </div>
</header>

<div id="settings-panel">
  <div class="panel-inner">
    <p>Optional — without a token, your list is saved to this browser only. With a
GitHub Personal Access Token, your progress and notes sync to a private Gist
and are accessible from any browser where you enter the token.</p>
    <p>Create a token at github.com/settings/tokens — select Gist scope only
(no other permissions needed). The token is stored only in this browser's
local storage, never transmitted anywhere except the GitHub API.</p>
    <div class="pat-row">
      <input type="password" id="pat-input" placeholder="ghp_…" autocomplete="off" spellcheck="false">
      <button class="btn-sm" id="pat-save-btn">Save</button>
      <button class="btn-sm" id="pat-clear-btn">Clear</button>
    </div>
    <div id="sync-status" class="local">● Saved locally</div>
  </div>
</div>

<div id="main">
  <div id="progress-wrap">
    <div id="progress-bar-bg"><div id="progress-bar-fill"></div></div>
    <span id="progress-label">0 / 0 items checked</span>
  </div>
  <div id="list-container"></div>
</div>

<footer>
  <div id="footer">
    <span id="footer-note">Prices approximate.</span>
    <button id="reset-btn">Reset all</button>
  </div>
</footer>

<script>
(function () {
  'use strict';

  // ── Constants ──────────────────────────────────────────────────────────────
  const LIST_ID   = 'diy-controller';
  const GIST_FILE = 'diy-controller-shopping-list.json';

  const LS_STATE_KEY = 'martha_shopping_' + LIST_ID;
  const LS_PAT_KEY   = 'martha_pat';
  const LS_GIST_KEY  = 'martha_gist_id_' + LIST_ID;

  // ── List data ──────────────────────────────────────────────────────────────
  const LIST_DATA = [
    { section: 'Core Electronics', id: 'core', items: [
      { id: 'core-esp32s3', label: 'ESP32-S3 DevKitC-1 (38-pin)', price: '~$10–15', url: 'https://www.adafruit.com/product/5312' },
      { id: 'core-relay', label: '8-channel 3.3V-compatible opto-isolated relay module', price: '~$10–12', url: 'https://www.amazon.com/s?k=8+channel+relay+module+3.3v+optocoupler' },
      { id: 'core-scd30', label: 'Sensirion SCD30 (CO₂ / temp / RH)', price: '$58.95', url: 'https://www.adafruit.com/product/4867' },
      { id: 'core-sht45', label: 'Sensirion SHT45 breakout (PTFE filter) ×3', price: '~$13.50 ea', url: 'https://www.adafruit.com/product/6174' },
      { id: 'core-tca9548a', label: 'TCA9548A 8-channel I²C multiplexer', price: '$6.95', url: 'https://www.adafruit.com/product/2717' },
      { id: 'core-water', label: 'DFRobot KIT0139 submersible pressure water level sensor', price: '~$44', url: 'https://www.dfrobot.com/product-1863.html' },
      { id: 'core-ds18b20', label: 'DS18B20 waterproof temp probe 1m ×5', price: '~$10 ea', url: 'https://www.adafruit.com/product/381' },
      { id: 'core-as7341', label: 'AS7341 11-channel spectral light sensor', price: '~$12', url: 'https://www.adafruit.com/product/4698' },
    ]},
    { section: 'Power', id: 'power', items: [
      { id: 'power-5v', label: '5V 3A DIN-rail PSU — Meanwell HDR-15-5 or Mornsun equivalent', price: '~$20–30', url: 'https://www.digikey.com/en/products/detail/mean-well-usa-inc/HDR-15-5/7703796' },
      { id: 'power-12v', label: '12V 1A DIN-rail PSU — Meanwell HDR-15-12', price: '~$10', url: 'https://www.mouser.com/ProductDetail/MEAN-WELL/HDR-15-12' },
    ]},
    { section: 'Enclosure', id: 'encl', items: [
      { id: 'encl-box', label: 'IP65 enclosure — min 250×200×100mm', price: '~$20–30', url: 'https://www.amazon.com/LeMotech-Dustproof-Waterproof-Electrical-200mmx100mmx70mm/dp/B075DKJ3LX' },
      { id: 'encl-din', label: '35mm DIN rail (cut to width)', price: '~$5', url: 'https://www.amazon.com/VAMRONE-Aluminum-Rails-7-5mm-Slotted/dp/B0D99K9XTF' },
      { id: 'encl-glands', label: 'Cable glands — PG9 ×4, PG11 ×6, PG16 ×1', price: '~$8', url: 'https://www.amazon.com/TUPARKA-Waterproof-Connectors-Adjustable-Plastic/dp/B0BLYSTRL5' },
    ]},
    { section: 'Safety & Protection (Required)', id: 'safety', items: [
      { id: 'safety-gfci', label: 'GFCI outlet or DIN-rail RCD — 30mA trip (REQUIRED)', price: '~$15–40', url: 'https://www.amazon.com/Leviton-GFNT1-DIN-Extra-Heavy-Industrial-Receptacle/dp/B01FX5NTKY' },
      { id: 'safety-fuse', label: 'Blade fuse block — DIN rail, 4–8 position', price: '~$12–15', url: 'https://www.amazon.com/Position-Mount-Distribution-Module-Terminal/dp/B0DXFTW33H' },
      { id: 'safety-r1k', label: '1kΩ resistor ¼W — series protection, GPIO 7 ADC', price: '<$1', url: 'https://www.digikey.com/en/products/detail/yageo/CFR-25JB-52-1K/338' },
      { id: 'safety-zener', label: '3.3V Zener diode or SMBJ3V3A TVS — overvoltage clamp', price: '<$1', url: 'https://www.digikey.com/en/products/detail/vishay-semiconductor-diodes-division/SMBJ3V3A-E3-52/1622390' },
      { id: 'safety-r100k', label: '100kΩ resistor ¼W — GPIO 7 pull-down', price: '<$1', url: 'https://www.digikey.com/en/products/detail/yageo/CFR-25JB-52-100K/338' },
    ]},
    { section: 'Panel & Wiring', id: 'wire', items: [
      { id: 'wire-dpdt', label: 'DPDT toggle switch (master AUTO/MANUAL)', price: '~$3–5', url: 'https://www.amazon.com/Panel-Position-Toggle-Switch-KN11-203/dp/B0946KD4L8' },
      { id: 'wire-spst', label: 'SPST toggle switch ×4 (HUMIDITY, FAE, UVC, LIGHTS)', price: '~$2–4 ea', url: 'https://www.amazon.com/C511B-Panel-Mount-Toggle-Switch/dp/B00Y01ACP8' },
      { id: 'wire-r10k', label: '10kΩ resistor ¼W ×8 (relay IN pin pull-ups)', price: '<$1', url: 'https://www.digikey.com/en/products/detail/yageo/CFR-25JB-52-10K/338' },
      { id: 'wire-r2k2', label: '2.2kΩ resistor ¼W (1-Wire pull-up)', price: '<$1', url: 'https://www.digikey.com/en/products/detail/yageo/CFR-25JB-52-2K2/338' },
      { id: 'wire-c100nf', label: '100nF ceramic capacitor (1-Wire decoupling)', price: '<$1', url: 'https://www.digikey.com/en/products/detail/kemet/C320C104K5R5TA7301/3726028' },
      { id: 'wire-22awg', label: '22 AWG stranded wire — low-voltage runs', price: '~$10', url: 'https://www.amazon.com/Hook-Up-Wire-Assortment-Stranded-AWG/dp/B01HP250ZK' },
      { id: 'wire-14awg', label: '14 AWG stranded wire — mains runs', price: '~$10', url: 'https://www.amazon.com/s?k=14+awg+stranded+wire+spool' },
      { id: 'wire-wago', label: 'Wago 221-412 lever connectors (mains connections)', price: '~$10', url: 'https://www.amazon.com/Wago-221-412-LEVER-NUTS-Conductor-Connectors/dp/B01AIC8LZU' },
      { id: 'wire-ferrule', label: 'Ferrule crimp kit — 22 AWG + 14 AWG + crimping tool', price: '~$10', url: 'https://www.amazon.com/Preciva-Self-adjustable-Terminals-Connectors-Uninsulated/dp/B073TZ5BBG' },
      { id: 'wire-terminal', label: 'DIN rail terminal block strip 10-position ×2', price: '~$8', url: 'https://www.amazon.com/JANDECCN-Terminal-Universal-Connectors-Connection/dp/B0C2YJGG2G' },
      { id: 'wire-fuse', label: 'Panel-mount fuse holder + 5A fuse', price: '~$5', url: 'https://www.amazon.com/s?k=panel+mount+fuse+holder+5a' },
    ]},
    { section: 'Misc', id: 'misc', items: [
      { id: 'misc-standoffs', label: 'M3 standoffs 10mm (mount ESP32-S3 + relay board)', price: '~$3', url: 'https://www.amazon.com/s?k=m3+standoffs+10mm+assortment' },
      { id: 'misc-velcro', label: 'Zip ties + velcro (cable management)', price: '~$3', url: 'https://www.amazon.com/VELCRO-Brand-Industrial-Fasteners-Professional/dp/B00114LOMM' },
      { id: 'misc-heatshrink', label: 'Heat shrink tubing assortment', price: '~$3', url: 'https://www.amazon.com/s?k=heat+shrink+tubing+assortment' },
      { id: 'misc-labels', label: 'Label maker tape (label every wire at both ends)', price: '~$2', url: 'https://www.amazon.com/s?k=label+maker+tape' },
    ]},
    { section: 'Tools Required', id: 'tools', items: [
      { id: 'tool-iron', label: 'Soldering iron + solder', price: '', url: 'https://www.amazon.com/s?k=soldering+iron+kit' },
      { id: 'tool-strippers', label: 'Wire strippers — 22 AWG and 14 AWG', price: '', url: 'https://www.amazon.com/s?k=wire+stripper+22+14+awg' },
      { id: 'tool-crimper', label: 'Ferrule crimping tool', price: '', url: 'https://www.amazon.com/Preciva-Self-adjustable-Terminals-Connectors-Uninsulated/dp/B073TZ5BBG' },
      { id: 'tool-meter', label: 'Multimeter (essential)', price: '', url: 'https://www.amazon.com/s?k=multimeter' },
      { id: 'tool-drill', label: 'Drill + step bit (enclosure cutouts)', price: '', url: 'https://www.amazon.com/s?k=step+drill+bit+set' },
      { id: 'tool-screwdrivers', label: 'Screwdrivers — flathead + Phillips', price: '' },
    ]},
    { section: 'Optional: Pump Add-on (~$20)', id: 'pump', items: [
      { id: 'pump-pump', label: '12V DC submersible pump — 3–5 L/min, food-safe', price: '~$10', optional: true, url: 'https://www.amazon.com/Degrees-Circulation-Brushless-Submersible-Electric/dp/B0FKYWFBFL' },
      { id: 'pump-tubing', label: 'Food-safe silicone tubing — 3/8" or 1/2" ID', price: '~$5', optional: true, url: 'https://www.amazon.com/Ultra-Clear-Platinum-Silicone-Tubing/dp/B082RGQBJD' },
      { id: 'pump-valve', label: 'Check valve (prevents backflow)', price: '~$5', optional: true, url: 'https://www.amazon.com/Barbed-Check-Replaces-Bunn-33027-0001/dp/B00NMJ4FIE' },
    ]},
  ];

  // ── State ──────────────────────────────────────────────────────────────────
  let state = {};          // { [itemId]: { checked: boolean, note: string } }
  let gistSyncTimer = null;
  let noteSaveTimers = {};

  // ── localStorage helpers ───────────────────────────────────────────────────
  function loadLocalState() {
    try {
      const raw = localStorage.getItem(LS_STATE_KEY);
      return raw ? JSON.parse(raw) : {};
    } catch { return {}; }
  }

  function saveLocalState() {
    try {
      localStorage.setItem(LS_STATE_KEY, JSON.stringify(state));
    } catch {}
  }

  function getPat() {
    return localStorage.getItem(LS_PAT_KEY) || '';
  }

  function getGistId() {
    return localStorage.getItem(LS_GIST_KEY) || '';
  }

  function setGistId(id) {
    localStorage.setItem(LS_GIST_KEY, id);
  }

  // ── Sync status UI ─────────────────────────────────────────────────────────
  const syncStatusEl = document.getElementById('sync-status');

  function setSyncStatus(type, msg) {
    syncStatusEl.className = type;
    syncStatusEl.textContent = msg;
  }

  // ── GitHub Gist API ────────────────────────────────────────────────────────
  async function apiFetch(path, opts = {}) {
    const pat = getPat();
    const headers = {
      'Accept': 'application/vnd.github+json',
      'Content-Type': 'application/json',
    };
    if (pat) headers['Authorization'] = 'Bearer ' + pat;
    const res = await fetch('https://api.github.com' + path, { ...opts, headers });
    return res;
  }

  async function findOrCreateGist() {
    // 1. Try stored gist id
    const storedId = getGistId();
    if (storedId) {
      const res = await apiFetch('/gists/' + storedId);
      if (res.ok) {
        const data = await res.json();
        if (data.files && data.files[GIST_FILE]) return data.id;
      }
    }

    // 2. List gists, search for matching file
    const res = await apiFetch('/gists?per_page=100');
    if (!res.ok) throw new Error('Could not list gists: ' + res.status);
    const gists = await res.json();
    for (const g of gists) {
      if (g.files && g.files[GIST_FILE]) {
        setGistId(g.id);
        return g.id;
      }
    }

    // 3. Create new gist
    const body = JSON.stringify({
      description: 'Martha shopping list: ' + LIST_ID,
      public: false,
      files: {
        [GIST_FILE]: { content: JSON.stringify(makeGistContent(), null, 2) }
      }
    });
    const createRes = await apiFetch('/gists', { method: 'POST', body });
    if (!createRes.ok) throw new Error('Could not create gist: ' + createRes.status);
    const created = await createRes.json();
    setGistId(created.id);
    return created.id;
  }

  function makeGistContent() {
    return {
      version: 1,
      listId: LIST_ID,
      savedAt: new Date().toISOString(),
      items: state,
    };
  }

  async function loadFromGist() {
    const gistId = await findOrCreateGist();
    const res = await apiFetch('/gists/' + gistId);
    if (!res.ok) throw new Error('Could not fetch gist: ' + res.status);
    const data = await res.json();
    const file = data.files[GIST_FILE];
    if (!file || !file.content) return;
    const parsed = JSON.parse(file.content);
    if (parsed && parsed.items) {
      state = parsed.items;
    }
  }

  async function saveToGist() {
    setSyncStatus('syncing', '↻ Syncing…');
    try {
      const gistId = await findOrCreateGist();
      const body = JSON.stringify({
        files: {
          [GIST_FILE]: { content: JSON.stringify(makeGistContent(), null, 2) }
        }
      });
      const res = await apiFetch('/gists/' + gistId, { method: 'PATCH', body });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const now = new Date();
      const t = now.toTimeString().slice(0, 8);
      setSyncStatus('synced', '✓ Synced ' + t);
    } catch (e) {
      setSyncStatus('error', '✗ Error: ' + e.message);
    }
  }

  function scheduleGistSync() {
    if (!getPat()) return;
    clearTimeout(gistSyncTimer);
    gistSyncTimer = setTimeout(saveToGist, 1000);
  }

  // ── DOM building ───────────────────────────────────────────────────────────
  function getItemState(id) {
    return state[id] || { checked: false, note: '' };
  }

  function setItemChecked(id, val) {
    if (!state[id]) state[id] = { checked: false, note: '' };
    state[id].checked = val;
    saveLocalState();
    scheduleGistSync();
    if (!getPat()) setSyncStatus('local', '● Saved locally');
  }

  function setItemNote(id, val) {
    if (!state[id]) state[id] = { checked: false, note: '' };
    state[id].note = val;
    saveLocalState();
    scheduleGistSync();
    if (!getPat()) setSyncStatus('local', '● Saved locally');
  }

  function updateProgress() {
    let total = 0, checked = 0;
    LIST_DATA.forEach(sec => {
      sec.items.forEach(item => {
        total++;
        if (getItemState(item.id).checked) checked++;
      });
    });
    const pct = total === 0 ? 0 : Math.round((checked / total) * 100);
    document.getElementById('progress-bar-fill').style.width = pct + '%';
    document.getElementById('progress-label').textContent = checked + ' / ' + total + ' items checked';
  }

  function updateSectionBadge(sectionId) {
    const sec = LIST_DATA.find(s => s.id === sectionId);
    if (!sec) return;
    const total = sec.items.length;
    const checked = sec.items.filter(i => getItemState(i.id).checked).length;
    const badge = document.querySelector('[data-section-badge="' + sectionId + '"]');
    if (badge) badge.textContent = checked + ' / ' + total;
  }

  function buildItemRow(item) {
    const iState = getItemState(item.id);

    const row = document.createElement('div');
    row.className = 'item-row' + (iState.checked ? ' is-checked' : '');
    row.dataset.itemId = item.id;

    // Main line
    const main = document.createElement('div');
    main.className = 'item-main';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = 'cb-' + item.id;
    cb.checked = iState.checked;

    const label = document.createElement('label');
    label.className = 'item-label';
    label.htmlFor = 'cb-' + item.id;
    label.textContent = item.label;

    const meta = document.createElement('div');
    meta.className = 'item-meta';

    if (item.optional) {
      const badge = document.createElement('span');
      badge.className = 'badge-optional';
      badge.textContent = 'optional';
      meta.appendChild(badge);
    }

    if (item.price) {
      const price = document.createElement('span');
      price.className = 'item-price';
      price.textContent = item.price;
      meta.appendChild(price);
    }

    if (item.url) {
      const link = document.createElement('a');
      link.className = 'item-link';
      link.href = item.url;
      link.target = '_blank';
      link.rel = 'noopener noreferrer';
      link.title = 'Open link';
      link.textContent = '↗';
      meta.appendChild(link);
    }

    main.appendChild(cb);
    main.appendChild(label);
    main.appendChild(meta);

    // Note input
    const noteWrap = document.createElement('div');
    noteWrap.className = 'item-note-wrap';

    const noteInput = document.createElement('input');
    noteInput.type = 'text';
    noteInput.className = 'item-note' + (iState.note ? ' has-value' : '');
    noteInput.placeholder = 'note / substitution…';
    noteInput.value = iState.note || '';
    noteInput.setAttribute('aria-label', 'Note for ' + item.label);

    noteWrap.appendChild(noteInput);
    row.appendChild(main);
    row.appendChild(noteWrap);

    // Events
    cb.addEventListener('change', () => {
      const checked = cb.checked;
      row.classList.toggle('is-checked', checked);
      setItemChecked(item.id, checked);
      updateProgress();
      updateSectionBadge(findSectionId(item.id));
    });

    noteInput.addEventListener('input', () => {
      noteInput.classList.toggle('has-value', noteInput.value.length > 0);
      clearTimeout(noteSaveTimers[item.id]);
      noteSaveTimers[item.id] = setTimeout(() => {
        setItemNote(item.id, noteInput.value);
      }, 800);
    });

    noteInput.addEventListener('blur', () => {
      setItemNote(item.id, noteInput.value);
    });

    return row;
  }

  function findSectionId(itemId) {
    for (const sec of LIST_DATA) {
      if (sec.items.find(i => i.id === itemId)) return sec.id;
    }
    return null;
  }

  function buildSection(sec) {
    const card = document.createElement('div');
    card.className = 'section-card';
    card.dataset.sectionId = sec.id;

    // Header
    const header = document.createElement('div');
    header.className = 'section-header';
    header.setAttribute('role', 'button');
    header.setAttribute('tabindex', '0');
    header.setAttribute('aria-expanded', 'true');

    const title = document.createElement('span');
    title.className = 'section-title';
    title.textContent = sec.section;

    const badge = document.createElement('span');
    badge.className = 'section-badge';
    badge.dataset.sectionBadge = sec.id;
    const checkedCount = sec.items.filter(i => getItemState(i.id).checked).length;
    badge.textContent = checkedCount + ' / ' + sec.items.length;

    const chevron = document.createElement('span');
    chevron.className = 'section-chevron';
    chevron.textContent = '▾';

    header.appendChild(title);
    header.appendChild(badge);
    header.appendChild(chevron);

    // Body
    const body = document.createElement('div');
    body.className = 'section-body';

    sec.items.forEach(item => {
      body.appendChild(buildItemRow(item));
    });

    card.appendChild(header);
    card.appendChild(body);

    // Toggle collapse
    function toggleCollapse() {
      const collapsed = card.classList.toggle('collapsed');
      header.setAttribute('aria-expanded', String(!collapsed));
    }
    header.addEventListener('click', toggleCollapse);
    header.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleCollapse(); }
    });

    return card;
  }

  function renderList() {
    const container = document.getElementById('list-container');
    container.textContent = '';
    LIST_DATA.forEach(sec => container.appendChild(buildSection(sec)));
    updateProgress();
  }

  // ── Apply Gist state to existing DOM (no full re-render) ──────────────────
  function applyStateToDOM() {
    LIST_DATA.forEach(sec => {
      sec.items.forEach(item => {
        const iState = getItemState(item.id);
        const row = document.querySelector('[data-item-id="' + item.id + '"]');
        if (!row) return;
        const cb = row.querySelector('input[type="checkbox"]');
        const noteInput = row.querySelector('.item-note');
        if (cb) cb.checked = iState.checked;
        row.classList.toggle('is-checked', iState.checked);
        if (noteInput) {
          noteInput.value = iState.note || '';
          noteInput.classList.toggle('has-value', (iState.note || '').length > 0);
        }
      });
      updateSectionBadge(sec.id);
    });
    updateProgress();
  }

  // ── Settings panel ─────────────────────────────────────────────────────────
  const settingsBtn   = document.getElementById('settings-btn');
  const settingsPanel = document.getElementById('settings-panel');
  const patInput      = document.getElementById('pat-input');
  const patSaveBtn    = document.getElementById('pat-save-btn');
  const patClearBtn   = document.getElementById('pat-clear-btn');

  settingsBtn.addEventListener('click', () => {
    settingsPanel.classList.toggle('open');
  });

  patInput.value = getPat();

  patSaveBtn.addEventListener('click', async () => {
    const val = patInput.value.trim();
    if (val) {
      localStorage.setItem(LS_PAT_KEY, val);
      setSyncStatus('syncing', '↻ Syncing…');
      try {
        await loadFromGist();
        applyStateToDOM();
        await saveToGist();
      } catch (e) {
        setSyncStatus('error', '✗ Error: ' + e.message);
      }
    }
  });

  patClearBtn.addEventListener('click', () => {
    patInput.value = '';
    localStorage.removeItem(LS_PAT_KEY);
    localStorage.removeItem(LS_GIST_KEY);
    setSyncStatus('local', '● Saved locally');
  });

  // ── Reset ──────────────────────────────────────────────────────────────────
  document.getElementById('reset-btn').addEventListener('click', () => {
    if (confirm('Reset all checkboxes and notes? This cannot be undone.')) {
      state = {};
      saveLocalState();
      applyStateToDOM();
      if (getPat()) saveToGist();
      else setSyncStatus('local', '● Saved locally');
    }
  });

  // ── Init ───────────────────────────────────────────────────────────────────
  async function init() {
    state = loadLocalState();
    renderList();

    const pat = getPat();
    if (pat) {
      setSyncStatus('syncing', '↻ Syncing…');
      try {
        await loadFromGist();
        applyStateToDOM();
        const now = new Date();
        setSyncStatus('synced', '✓ Synced ' + now.toTimeString().slice(0, 8));
      } catch (e) {
        setSyncStatus('error', '✗ Error: ' + e.message);
      }
    } else {
      setSyncStatus('local', '● Saved locally');
    }
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
